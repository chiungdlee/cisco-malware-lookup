# Malware URL Lookup Service

## Overview

This project provides a scalable malware URL lookup service. The system consists of three primary microservices: `auth-service`, `urlinfo-service`, and `update-service`. The infrastructure is managed using Terraform, and the services are deployed on Azure Kubernetes Service (AKS) with Helm charts. Horizontal Pod Autoscaler (HPA) and Kubernetes CronJobs are used to ensure scalability and reliability.

## 1. auth-service

### Purpose
The `auth-service` provides authentication and issues JWT tokens for secure access to the other services.

### Location
- Code: `src/auth.py`
- Helm Chart: `helm/charts/auth`

### How It Works
- **Login Endpoint (`/login`)**: Authenticates users and returns a JWT token.
  - Receives a JSON payload with `username` and `password`.
  - Validates the credentials (currently hardcoded for demo purposes).
  - Issues a JWT token if the credentials are valid.
- **JWT Management**: Utilizes `flask_jwt_extended` to handle JWT creation and validation.

## 2. urlinfo-service

### Purpose
The `urlinfo-service` checks if a given URL is safe or potentially malicious based on data stored in the database.

### Location
- Code: `src/app.py`
- Helm Chart: `helm/charts/urlinfo`

### Scaling
Configured with Horizontal Pod Autoscaler (HPA) to handle varying loads.

### How It Works
- **URL Info Endpoint (`/v1/urlinfo/<path:resource_url>`)**: Requires a valid JWT token.
  - Checks the database to see if the URL is listed as malicious.
  - Returns a JSON response indicating whether the URL is safe or not.

## 3. update-service

### Purpose
The `update-service` periodically fetches the latest list of malicious URLs from an external source and updates the database.

### Location
- Code: `src/update_service.py`
- Helm Chart: `helm/charts/update`

### Execution
Triggered by a Kubernetes CronJob defined in `cronjob.yaml`.

### How It Works
- **Fetch Updates**: Retrieves new malware URLs from an external API.
- **Run**: Updates the database with new malware URLs.


## 4. **Infrastructure**
- **Terraform**: Used to provision and manage cloud resources, including AKS, MySQL database, and more.
- **Ansible**: Used for additional configuration management post-deployment.

## Key Features

### 1. Data Scalability
The application stores URL data in an external MySQL database. The database can be easily scaled using Terraform, which allows us to adjust the database's capacity based on the load. This ensures that our system can handle an increasing amount of data without performance degradation.

### 2. Request Scalability
The number of incoming requests might exceed the capacity of a single system. To handle this, the system is deployed on Azure Kubernetes Service (AKS), which provides the ability to scale horizontally. The Horizontal Pod Autoscaler (HPA) automatically adjusts the number of pod replicas based on CPU utilization or other metrics. If the cluster gets flooded, we can customize Terraform to add more nodes to the node pool, ensuring the system remains responsive.

### 3. Efficient Scheduling with CronJobs
Instead of running the update-service in an infinite loop to fetch updates every 10 minutes, we use Kubernetes CronJobs. The CronJob schedules the fetch operation at regular intervals, ensuring that updates are performed efficiently without the need for a long-running process. This approach reduces resource usage and improves reliability.

## Deployment

### Prerequisites
- Docker
- Kubernetes
- Helm
- Terraform
- Ansible

### Steps

1. **Clone the repository**:
```sh
   git clone https://github.com/your-repo/malware_url_lookup.git
```

2. **Build and push Docker images**:
```sh
    docker build -t your-docker-repo/auth-service:latest -f Dockerfile.auth .
    docker push your-docker-repo/auth-service:latest

    docker build -t your-docker-repo/urlinfo-service:latest -f Dockerfile.urlinfo .
    docker push your-docker-repo/urlinfo-service:latest

    docker build -t your-docker-repo/update-service:latest -f Dockerfile.update .
    docker push your-docker-repo/update-service:latest
```

3. **Provision infrastructure with Terraform**:
```sh
    cd terraform
    terraform init
    terraform apply -auto-approve
```
4. **Deploy services with Helm:**:
```sh
    helm upgrade --install auth-service helm/charts/auth --set image.repository=your-docker-repo/auth-service,image.tag=latest
    helm upgrade --install urlinfo-service helm/charts/urlinfo --set image.repository=your-docker-repo/urlinfo-service,image.tag=latest
    helm upgrade --install update-service helm/charts/update --set image.repository=your-docker-repo/update-service,image.tag=latest
```

5. **Apply CronJob**:
```sh
    kubectl apply -f cronjob.yaml
```

6. **Apply HPA**:
```sh
    kubectl apply -f helm/charts/urlinfo/templates/hpa.yaml
```

### Running Tests

#### Unit Tests
To run the unit tests:
```sh
python -m unittest discover -s tests
```

#### Functional Tests
To run the functional tests:
```sh
python -m unittest discover -s tests/functional
```

#### Performance Tests
To run the JMeter performance tests:
```sh
jmeter -n -t tests/performance_test.jmx -l tests/performance_test.jtl
```

## Conclusion

This project demonstrates a comprehensive approach to building a scalable malware URL lookup service using modern DevOps practices. By leveraging Kubernetes, Helm, Terraform, and Ansible, we ensure that the system is highly available, scalable, and maintainable.

### Key Points:

1. **Data Scalability**: External database managed by Terraform ensures scalability.
2. **Request Handling**: AKS and HPA manage load balancing and scaling.
3. **Efficient Scheduling**: Kubernetes CronJob efficiently handles periodic tasks.

Feel free to contribute to this project by submitting issues or pull requests. For any questions, please contact [chiungdlee@gmai.com].
